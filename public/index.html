<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Kumano Compass - Voice Input</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #e3f2fd;
      --primary-gradient: linear-gradient(135deg, #2563eb, #4f46e5);
      --accent: #00bfa5;
      --danger: #e53935;
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --text-main: #222b45;
      --text-sub: #6b7280;
      --border-soft: #e5e7eb;
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-full: 999px;
      --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.08);
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0ecff 0, #f6f7fb 40%, #f3f6fb 100%);
      color: var(--text-main);
    }

    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡æ›¿ãƒ©ãƒƒãƒ‘ãƒ¼ */

    .layout-desktop,
    .layout-mobile {
      width: 100%;
    }

    .layout-desktop {
      display: block;
    }

    .layout-mobile {
      display: none;
    }

    @media (max-width: 768px) {
      .layout-desktop {
        display: none;
      }
      .layout-mobile {
        display: block;
      }
    }

    /* ==== PCç‰ˆã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå…ƒ index.htmlï¼‰ ==== */

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 16px;
    }

    .app-header {
      width: 100%;
      max-width: 960px;
      margin-bottom: 24px;
    }

    .app-title {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      font-weight: 600;
    }

    .app-subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: var(--text-sub);
    }

    .card {
      width: 100%;
      max-width: 960px;
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      padding: 24px 24px 20px;
      display: grid;
      grid-template-columns: 1.1fr 1.6fr;
      gap: 24px;
      position: relative;
      overflow: hidden;
      transition: transform 0.18s ease, box-shadow 0.25s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.14);
    }

    .card-left {
      border-right: 1px solid #e5e7eb;
      padding-right: 20px;
    }

    .field-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-sub);
      margin-bottom: 6px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .field-group {
      margin-bottom: 16px;
    }

    .select-row {
      display: flex;
      gap: 10px;
    }

    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d4d4d8;
      background: #f9fafb;
      font-size: 13px;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast),
        transform 0.16s ease;
    }

    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
      background: #ffffff;
      transform: translateY(-1px);
    }

    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    button {
      border: none;
      cursor: pointer;
      font-family: inherit;
    }

    .btn {
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background var(--transition-fast),
        transform var(--transition-fast), box-shadow var(--transition-fast),
        opacity var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #0052cc, #0084ff);
      color: #ffffff;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.28);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
    }

    .btn-outline {
      background: #f3f4f6;
      color: #111827;
    }

    .btn-outline:hover:not(:disabled) {
      background: #e5e7eb;
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #eff6ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .btn-loading {
      position: relative;
      padding-right: 30px;
    }

    .btn-loading::after {
      content: "";
      position: absolute;
      right: 10px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.7);
      border-top-color: rgba(255, 255, 255, 0.1);
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .hint-text {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .hint-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ecfdf5;
      color: #15803d;
      margin-top: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.28);
      animation: pulse 1.4s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.95);
        opacity: 0.9;
      }
      70% {
        transform: scale(1.06);
        opacity: 0.2;
      }
      100% {
        transform: scale(0.95);
        opacity: 0.9;
      }
    }

    .card-right {
      display: flex;
      flex-direction: column;
    }

    .textarea-wrapper {
      position: relative;
      flex: 1;
    }

    textarea {
      width: 100%;
      height: 170px;
      resize: vertical;
      padding: 12px 14px 32px;
      border-radius: var(--radius-lg);
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 13px;
      line-height: 1.6;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast),
        transform var(--transition-fast);
    }

    textarea:focus {
      border-color: var(--primary);
      background: #ffffff;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.18);
      transform: translateY(-1px);
    }

    .textarea-footer {
      position: absolute;
      bottom: 8px;
      right: 10px;
      font-size: 11px;
      color: var(--text-sub);
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .chip {
      padding: 3px 7px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 11px;
    }

    .toast-pc {
      position: fixed;
      right: 24px;
      bottom: 24px;
      background: #111827;
      color: #f9fafb;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.5);
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 50;
    }

    .toast-pc.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast-pc.success {
      background: #022c22;
    }

    .toast-pc.error {
      background: #7f1d1d;
    }

    .toast-icon {
      font-size: 16px;
    }

    @media (max-width: 840px) {
      .card {
        grid-template-columns: 1fr;
        padding: 18px 16px;
      }
      .card-left {
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
        padding-right: 0;
        padding-bottom: 16px;
        margin-bottom: 10px;
      }
    }

    /* ==== ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå…ƒ mobile.htmlï¼‰ ==== */

    .layout-mobile .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 12px 12px 24px;
    }

    .layout-mobile .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 6px 6px;
    }

    .layout-mobile .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .layout-mobile .brand-dot {
      width: 20px;
      height: 20px;
      border-radius: 10px;
      background: radial-gradient(
        circle at 30% 20%,
        #ffffff 0,
        #93c5fd 35%,
        #2563eb 100%
      );
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.18);
    }

    .layout-mobile .brand-name {
      display: none; 
    }

    .layout-mobile .brand-sub {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
    }

    .layout-mobile .header-tag {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.08);
      color: #1d4ed8;
      border: 1px solid rgba(37, 99, 235, 0.18);
      backdrop-filter: blur(8px);
    }

    .layout-mobile .app-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 4px;
    }

    .layout-mobile .card {
      background: var(--card-bg);
      border-radius: 22px;
      padding: 14px 14px 16px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.12);
      position: relative;
      overflow: hidden;
      transition: transform 0.16s ease, box-shadow 0.24s ease;
    }

    .layout-mobile .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(
        circle at top right,
        rgba(59, 130, 246, 0.06),
        transparent 60%
      );
      pointer-events: none;
    }

    .layout-mobile .card:active {
      transform: translateY(1px);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.12);
    }

    .layout-mobile .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .layout-mobile .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #6b7280;
    }

    .layout-mobile .card-caption {
      font-size: 11px;
      color: var(--text-sub);
    }

    .layout-mobile .field-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .layout-mobile .field {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .layout-mobile .field-label {
      font-size: 11px;
      color: var(--text-sub);
    }

    .layout-mobile .select-wrapper {
      position: relative;
      border-radius: var(--radius-full);
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 6px 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .layout-mobile .select-wrapper::after {
      content: "â–¾";
      font-size: 10px;
      color: #9ca3af;
      margin-left: auto;
    }

    .layout-mobile select {
      border: none;
      background: transparent;
      font-size: 13px;
      width: 100%;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
    }

    .layout-mobile .status-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
      font-size: 11px;
    }

    .layout-mobile .chip {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text-sub);
    }

    .layout-mobile .chip-success {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: #15803d;
    }

    .layout-mobile .chip-error {
      background: #fef2f2;
      border-color: #fecaca;
      color: #b91c1c;
    }

    .layout-mobile .textarea-wrapper {
      margin-top: 4px;
      border-radius: 18px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 8px 10px 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .layout-mobile textarea {
      width: 100%;
      border: none;
      background: transparent;
      resize: none;
      min-height: 140px;
      font-size: 14px;
      line-height: 1.5;
      outline: none;
      color: var(--text-main);
    }

    .layout-mobile .textarea-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 3px;
    }

    .layout-mobile .hint {
      color: var(--text-sub);
    }

    .layout-mobile .char-count {
      font-variant-numeric: tabular-nums;
    }

    .layout-mobile .button-row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .layout-mobile .btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.12s ease,
        background 0.12s ease;
      outline: none;
      position: relative;
      overflow: hidden;
    }

    .layout-mobile .btn:disabled {
      opacity: 0.65;
      cursor: default;
      box-shadow: none;
    }

    .layout-mobile .btn-primary {
      background-image: var(--primary-gradient);
      color: #ffffff;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.45);
    }

    .layout-mobile .btn-secondary {
      background: #eef2ff;
      color: #3730a3;
      box-shadow: 0 6px 18px rgba(129, 140, 248, 0.35);
    }

    .layout-mobile .btn-pressed {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.16);
    }

    .layout-mobile .btn-icon-circle {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.16);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .layout-mobile .btn-label {
      white-space: nowrap;
    }

    .layout-mobile .btn-primary .spinner {
      display: none;
    }

    .layout-mobile .btn-primary.loading .spinner {
      display: inline-block;
    }

    .layout-mobile .btn-primary.loading .btn-label {
      opacity: 0;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
      animation: spin 0.7s linear infinite;
    }

    .layout-mobile .btn-secondary.recording {
      background: #fee2e2;
      color: #b91c1c;
      box-shadow: 0 8px 18px rgba(248, 113, 113, 0.55);
    }

    .layout-mobile .pulse-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #ef4444;
      box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.6);
      animation: pulse 1.3s infinite;
    }

    .toast-mobile {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(120%);
      background: #111827;
      color: #f9fafb;
      padding: 9px 14px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.5);
      opacity: 0;
      transition: transform 0.22s ease, opacity 0.22s ease;
      z-index: 40;
      max-width: 90%;
      text-align: center;
    }

    .toast-mobile.show {
      transform: translateX(-50%) translateY(0%);
      opacity: 1;
    }

    .toast-mobile.error {
      background: #b91c1c;
    }

    @media (max-width: 360px) {
      .layout-mobile .button-row {
        flex-direction: column;
      }
    }

    /* ==== Kumano Compass å…±é€šãƒŠãƒ“ãƒãƒ¼ ==================== */
    .kc-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      z-index: 1000;
      padding: 0 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top left,
                  rgba(226, 239, 255, 0.95),
                  rgba(255, 255, 255, 0.98));
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.10);
      border-bottom: 1px solid rgba(209, 213, 219, 0.7);
    }

    .kc-nav-inner {
      width: 100%;
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .kc-nav-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
      cursor: pointer;
      padding: 6px 0;
      border: none;
      background: transparent;
    }

    .kc-nav-logo-dot {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #ffffff 0, #93c5fd 35%, #2563eb 100%);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.22);
      animation: kc-nav-breath 3.2s ease-in-out infinite;
    }

    .kc-nav-logo-text {
      display: flex;
      flex-direction: column;
    }

    .kc-nav-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.06em;
    }

    .kc-nav-sub {
      font-size: 11px;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .kc-nav-center {
      flex: 1;
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .kc-nav-link {
      position: relative;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      color: #4b5563;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(148, 163, 184, 0.7); /* â† æ ç·šã¤ã‘ã‚‹ */
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      transition:
        background 0.18s ease-out,
        color 0.18s ease-out,
        transform 0.18s ease-out,
        border-color 0.18s ease-out;
    }

    .kc-nav-link::after {
      content: "";
      position: absolute;
      left: 14px;
      right: 14px;
      bottom: 4px;
      height: 2px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.9);
      transform: scaleX(0);
      transform-origin: center;
      transition: transform 0.2s ease-out;
    }

    .kc-nav-link:hover {
      background: rgba(239, 246, 255, 0.95);
      border-color: rgba(59, 130, 246, 0.9); /* ãƒ›ãƒãƒ¼æ™‚ã«æ ã‚’å°‘ã—æ¿ƒã */
      transform: translateY(-1px);
    }

    .kc-nav-link:hover::after {
      transform: scaleX(1);
    }

    .kc-nav-link.active {
      background: rgba(219, 234, 254, 0.95);
      color: #1d4ed8;
      border-color: rgba(37, 99, 235, 1); /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¯ã—ã£ã‹ã‚Šé’æ  */
    }

    .kc-nav-link.active::after {
      transform: scaleX(1);
    }

    .kc-nav-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .kc-nav-pill {
      font-size: 10px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.12);
      color: #6b7280;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .kc-nav-pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.35);
    }

    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æŠ¼ã—ä¸‹ã’ç”¨ï¼ˆindex/adminã§ä½¿ã†ï¼‰ */
    .kc-nav-spacer {
      height: 72px;
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */

    @keyframes kc-nav-slide-in {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0%);
        opacity: 1;
      }
    }

    @keyframes kc-nav-breath {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.22);
      }
      50% {
        transform: scale(1.06);
        box-shadow: 0 0 0 8px rgba(37, 99, 235, 0.0);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.22);
      }
    }

    /* === å…±é€šãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ï¼šã‚¹ãƒãƒ›ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆè¦–èªæ€§é‡è¦–ï¼‰ === */
    @media (max-width: 768px) {
      .kc-nav {
        height: 70px;
        padding: 6px 10px;
      }

      .kc-nav-inner {
        align-items: center;
        gap: 6px;
      }

      .kc-nav-left {
        gap: 6px;
      }

      .kc-nav-logo-dot {
        width: 22px;
        height: 22px;
      }

      .kc-nav-title {
        font-size: 13px;
        letter-spacing: 0.03em;
      }

      /* èª¬æ˜æ–‡ã¯ã‚¹ãƒãƒ›ã§ã¯éè¡¨ç¤ºã«ã—ã¦ãƒŠãƒ“ã‚’ã‚¹ãƒƒã‚­ãƒª */
      .kc-nav-sub {
        display: none;
      }

      /* ä¸­å¤®ã‚¿ãƒ–ï¼š3ã¤ã‚’å‡ç­‰å¹…ã®å¤§ããªãƒœã‚¿ãƒ³ã«ã™ã‚‹ */
      .kc-nav-center {
        flex: 1;
        justify-content: space-between;
        gap: 4px;
      }

      .kc-nav-link {
        flex: 1;                     /* 3ã¤ã§æ¨ªå¹…ã‚’ç­‰åˆ† */
        justify-content: center;
        padding: 8px 4px;
        font-size: 11px;
      }

      /* ã“ã‚Œã¾ã§éš ã—ã¦ã„ãŸãƒ©ãƒ™ãƒ«ã‚‚ã‚¹ãƒãƒ›ã§è¡¨ç¤ºã—ã¦è¦–èªæ€§UP */
      .kc-nav-link span:last-child {
        display: inline;
      }

      /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ”ãƒ«ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼Supabaseé€£æºä¸­ï¼‰ã¯éš ã™ */
      .kc-nav-right .kc-nav-pill {
        display: none;
      }

      /* mapãƒšãƒ¼ã‚¸ãªã©ã®CTAãƒœã‚¿ãƒ³ã¯å°ã•ã‚ã«æ®‹ã™ */
      .kc-nav-right .kc-nav-cta {
        padding: 6px 10px;
        font-size: 11px;
      }

      /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æŠ¼ã—ä¸‹ã’é‡ã‚‚å°‘ã—å¢—ã‚„ã™ */
      .kc-nav-spacer {
        height: 78px;
      }
    }

  </style>
</head>
<body>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const links = document.querySelectorAll(".kc-nav-link");
    if (!links.length) return;

    // ç¾åœ¨ã®ãƒ‘ã‚¹ã‚’å–å¾—ã—ã¦æœ«å°¾ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å‰Šã‚‹ï¼ˆ/admin/ â†’ /adminï¼‰
    const rawPath = window.location.pathname || "/";
    const currentPath =
      rawPath.length > 1 ? rawPath.replace(/\/+$/, "") : rawPath;

    links.forEach((btn) => {
      const href = btn.getAttribute("data-nav-href");
      if (!href) return;

      const hrefNorm =
        href.length > 1 ? href.replace(/\/+$/, "") : href;

      // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã¨ä¸€è‡´ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      if (hrefNorm === currentPath) btn.classList.add("active");

      btn.addEventListener("click", () => {
        window.location.href = href;
      });
    });

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ãªã©ï¼‰
    const items = document.querySelectorAll(".kc-nav-item");
    if (items.length) {
      items.forEach((item) => {
        item.addEventListener("click", () => {
          const href = item.getAttribute("data-nav-href");
          if (href) {
            window.location.href = href;
          }
        });
      });
    }
  });
</script>

<!-- å…±é€šãƒŠãƒ“ãƒãƒ¼ -->
 <div class="kc-nav">
    <div class="kc-nav-inner">
      <!-- å·¦ãƒ­ã‚´ï¼šå…¥åŠ›ç”»é¢ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹ -->
      <button
        class="kc-nav-left"
        type="button"
        onclick="window.location.href='/public/index.html'"
      >
        <div class="kc-nav-logo-dot"></div>
        <div class="kc-nav-logo-text">
          <div class="kc-nav-title">Kumano Compass</div>
          <div class="kc-nav-sub">ä½æ°‘ã®å£° Â· å…¥åŠ›ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</div>
        </div>
      </button>

      <!-- ä¸­å¤®ã‚¿ãƒ– -->
      <div class="kc-nav-center">
        <a href="/public/index.html" class="kc-nav-link active">
          <span>ğŸ“</span><span>å…¥åŠ›</span>
        </a>
        <a href="/admin" class="kc-nav-link">
          <span>ğŸ“Š</span><span>ä¸€è¦§</span>
        </a>
        <a href="/admin/map" class="kc-nav-link">
          <span>ğŸ—º</span><span>ãƒãƒƒãƒ—</span>
        </a>
      </div>

      <!-- å³å´ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
      <div class="kc-nav-right">
        <div class="kc-nav-pill">
          <span class="kc-nav-pill-dot"></span>
          <span>ç¾åœ°å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒŠãƒ“ã®é«˜ã•åˆ†ã ã‘æŠ¼ã—ä¸‹ã’ -->
  <div class="kc-nav-spacer"></div>

  <!-- PCãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="layout-desktop">
    <div class="app-shell">
      <header class="app-header">
        <div class="app-title">
          <span class="app-pill">PCå…¥åŠ›ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</span>
        </div>
        <div class="app-subtitle">
          ç¾åœ°ã§èã„ãŸã€Œç”Ÿã®å£°ã€ã‚’ã€ãã®å ´ã§ç°¡å˜ã«è¨˜éŒ²ã— AI è§£æã¸é€ä¿¡ã§ãã¾ã™ã€‚
        </div>
      </header>

      <main class="card">
        <!-- å·¦ã‚«ãƒ©ãƒ ï¼šè¨­å®šãƒ»ãƒœã‚¿ãƒ³ -->
        <section class="card-left">
          <div class="field-group">
            <div class="field-label">AREAãƒ»SOURCE</div>
            <div class="select-row">
              <select id="area">
                <option value="ç¥å·">ç¥å·</option>
                <option value="æœ¨æœ¬">æœ¨æœ¬</option>
                <option value="é£›é³¥">é£›é³¥</option>
                <option value="å¸‚æœ¨">å¸‚æœ¨</option>
                <option value="ç´€å’Œ">ç´€å’Œ</option>
              </select>
              <select id="source">
                <option value="local">åœ°åŸŸã®æ–¹ã€…</option>
                <option value="ivusa">å­¦ç”Ÿ</option>
                <option value="tourist">è¦³å…‰å®¢</option>
              </select>
            </div>
          </div>
          <div class="field-group">
            <div class="field-label">å±æ€§ï¼ˆä»»æ„ï¼‰</div>
            <div class="select-row">
              <select id="age" aria-label="å¹´é½¢">
                <option value="">å¹´é½¢ï¼ˆæœªé¸æŠï¼‰</option>
                <option value="10ä»£">10ä»£</option>
                <option value="20ä»£">20ä»£</option>
                <option value="30ä»£">30ä»£</option>
                <option value="40ä»£">40ä»£</option>
                <option value="50ä»£">50ä»£</option>
                <option value="60ä»£">60ä»£</option>
                <option value="70ä»£ä»¥ä¸Š">70ä»£ä»¥ä¸Š</option>
                <option value="ä¸æ˜">ä¸æ˜</option>
              </select>

              <select id="gender" aria-label="æ€§åˆ¥">
                <option value="">æ€§åˆ¥ï¼ˆæœªé¸æŠï¼‰</option>
                <option value="ç”·æ€§">ç”·æ€§</option>
                <option value="å¥³æ€§">å¥³æ€§</option>
                <option value="ãã®ä»–/å›ç­”ã—ãªã„">ãã®ä»–/å›ç­”ã—ãªã„</option>
                <option value="ä¸æ˜">ä¸æ˜</option>
              </select>
            </div>

            <div class="select-row" style="margin-top:10px;">
              <select id="occupation" aria-label="è·æ¥­">
                <option value="">è·æ¥­ï¼ˆæœªé¸æŠï¼‰</option>
                <option value="ä¼šç¤¾å“¡">ä¼šç¤¾å“¡</option>
                <option value="è‡ªå–¶æ¥­">è‡ªå–¶æ¥­</option>
                <option value="å…¬å‹™å“¡">å…¬å‹™å“¡</option>
                <option value="å­¦ç”Ÿ">å­¦ç”Ÿ</option>
                <option value="ä¸»å©¦ãƒ»ä¸»å¤«">ä¸»å©¦ãƒ»ä¸»å¤«</option>
                <option value="è¾²æ—æ°´ç”£">è¾²æ—æ°´ç”£</option>
                <option value="è¦³å…‰æ¥­">è¦³å…‰æ¥­</option>
                <option value="åŒ»ç™‚ãƒ»ç¦ç¥‰">åŒ»ç™‚ãƒ»ç¦ç¥‰</option>
                <option value="æ•™è‚²">æ•™è‚²</option>
                <option value="ç„¡è·">ç„¡è·</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
                <option value="ä¸æ˜">ä¸æ˜</option>
              </select>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">RECORDING</div>
            <div class="button-row">
              <button id="recordBtn" class="btn btn-outline" type="button">
                <span class="btn-icon">ğŸ¤</span>
                <span id="recordBtnLabel">éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹</span>
              </button>
              <button
                id="sendBtn"
                class="btn btn-primary"
                type="button"
                onclick="saveData()"
              >
                ğŸ“© AIè§£æã—ã¦ä¿å­˜
              </button>
            </div>
            <div class="hint-text">
              <span class="hint-dot"></span>
              ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒã‚¤ã‚¯ãƒ»ä½ç½®æƒ…å ±ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚
            </div>
            <div id="geoStatus" class="status-pill" style="display: none;">
              <span class="status-dot"></span> ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ
            </div>
          </div>
        </section>

        <!-- å³ã‚«ãƒ©ãƒ ï¼šãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ -->
        <section class="card-right">
          <div class="field-label">TRANSCRIPT</div>
          <div class="textarea-wrapper">
            <textarea
              id="textOutput"
              placeholder="ãƒ’ã‚¢ãƒªãƒ³ã‚°ã—ãŸå†…å®¹ã‚’ãã®ã¾ã¾å…¥åŠ›ã™ã‚‹ã‹ã€éŸ³å£°å…¥åŠ›ã§è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚"
            ></textarea>
            <div class="textarea-footer">
              <span id="charCount" class="chip">0 æ–‡å­—</span>
              <span style="font-size: 11px; color: var(--text-sub);">
                Enter ã§æ”¹è¡Œã§ãã¾ã™
              </span>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- PCç”¨ãƒˆãƒ¼ã‚¹ãƒˆ -->
    <div id="toast-pc" class="toast-pc">
      <span id="toastIcon-pc" class="toast-icon">â„¹ï¸</span>
      <span id="toastMessage-pc"></span>
    </div>
  </div>

  <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
  <div class="layout-mobile">
    <div class="app">
      <header class="app-header">
          <span class="app-pill">ãƒ¢ãƒã‚¤ãƒ«å…¥åŠ›ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</span>
          <div class="app-subtitle">
          ã€Œç¾åœ°ã®å£°ã€ã‚’ãã®å ´ã§è¨˜éŒ²ã—ã€AIè§£æã¸é€ä¿¡ã§ãã¾ã™ã€‚
          </div>
      </header>

      <main class="app-main">
        <!-- Card 1: Area & Source -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">AREA Â· SOURCE</div>
            <div class="card-caption">ã©ã“ã§ã€èª°ã®å£°ã‹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          </div>

          <div class="field-row">
            <div class="field">
              <div class="field-label">åœ°åŒº</div>
              <div class="select-wrapper">
                <select id="area-mobile">
                  <option value="ç¥å·">ç¥å·</option>
                  <option value="æœ¨æœ¬">æœ¨æœ¬</option>
                  <option value="é£›é³¥">é£›é³¥</option>
                  <option value="å¸‚æœ¨">å¸‚æœ¨</option>
                  <option value="ç´€å’Œ">ç´€å’Œ</option>
                </select>
              </div>
            </div>

            <div class="field">
              <div class="field-label">ç¨®é¡</div>
              <div class="select-wrapper">
                <select id="source-mobile">
                  <option value="local">åœ°åŸŸã®æ–¹ã€…</option>
                  <option value="ivusa">å­¦ç”Ÿ</option>
                  <option value="tourist">è¦³å…‰å®¢ã®å£°</option>
                </select>
              </div>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <div class="field-label">å¹´é½¢ï¼ˆä»»æ„ï¼‰</div>
              <div class="select-wrapper">
                <select id="age-mobile">
                  <option value="">æœªé¸æŠ</option>
                  <option value="10ä»£">10ä»£</option>
                  <option value="20ä»£">20ä»£</option>
                  <option value="30ä»£">30ä»£</option>
                  <option value="40ä»£">40ä»£</option>
                  <option value="50ä»£">50ä»£</option>
                  <option value="60ä»£">60ä»£</option>
                  <option value="70ä»£ä»¥ä¸Š">70ä»£ä»¥ä¸Š</option>
                  <option value="ä¸æ˜">ä¸æ˜</option>
                </select>
              </div>
            </div>

            <div class="field">
              <div class="field-label">æ€§åˆ¥ï¼ˆä»»æ„ï¼‰</div>
              <div class="select-wrapper">
                <select id="gender-mobile">
                  <option value="">æœªé¸æŠ</option>
                  <option value="ç”·æ€§">ç”·æ€§</option>
                  <option value="å¥³æ€§">å¥³æ€§</option>
                  <option value="ãã®ä»–/å›ç­”ã—ãªã„">ãã®ä»–/å›ç­”ã—ãªã„</option>
                  <option value="ä¸æ˜">ä¸æ˜</option>
                </select>
              </div>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <div class="field-label">è·æ¥­ï¼ˆä»»æ„ï¼‰</div>
              <div class="select-wrapper">
                <select id="occupation-mobile">
                  <option value="">æœªé¸æŠ</option>
                  <option value="ä¼šç¤¾å“¡">ä¼šç¤¾å“¡</option>
                  <option value="è‡ªå–¶æ¥­">è‡ªå–¶æ¥­</option>
                  <option value="å…¬å‹™å“¡">å…¬å‹™å“¡</option>
                  <option value="å­¦ç”Ÿ">å­¦ç”Ÿ</option>
                  <option value="ä¸»å©¦ãƒ»ä¸»å¤«">ä¸»å©¦ãƒ»ä¸»å¤«</option>
                  <option value="è¾²æ—æ°´ç”£">è¾²æ—æ°´ç”£</option>
                  <option value="è¦³å…‰æ¥­">è¦³å…‰æ¥­</option>
                  <option value="åŒ»ç™‚ãƒ»ç¦ç¥‰">åŒ»ç™‚ãƒ»ç¦ç¥‰</option>
                  <option value="æ•™è‚²">æ•™è‚²</option>
                  <option value="ç„¡è·">ç„¡è·</option>
                  <option value="ãã®ä»–">ãã®ä»–</option>
                  <option value="ä¸æ˜">ä¸æ˜</option>
                </select>
              </div>
            </div>
          </div>

          <div class="status-row">
            <span id="geoStatus-mobile" class="chip">ğŸ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­â€¦</span>
            <span id="micStatus-mobile" class="chip">ğŸ™ ãƒã‚¤ã‚¯å¾…æ©Ÿä¸­</span>
          </div>
        </section>

        <!-- Card 2: Transcript -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">TRANSCRIPT</div>
            <div class="card-caption">ãƒ’ã‚¢ãƒªãƒ³ã‚°å†…å®¹ã‚’ãã®ã¾ã¾è¨˜éŒ²ã§ãã¾ã™</div>
          </div>

          <div class="textarea-wrapper">
            <textarea
              id="textOutput-mobile"
              placeholder="ä½æ°‘ã®æ–¹ã®ãŠè©±ã‚’ã€è¦ç´„ã›ãšã«ãã®ã¾ã¾ã®è¨€è‘‰ã§è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚&#10;éŸ³å£°å…¥åŠ›ã‚‚åˆ©ç”¨ã§ãã¾ã™ã€‚"
            ></textarea>
            <div class="textarea-footer">
              <span class="hint">Enter ã§æ”¹è¡Œã§ãã¾ã™</span>
              <span class="char-count"><span id="charCount-mobile">0</span> æ–‡å­—</span>
            </div>
          </div>

          <div class="button-row">
            <button id="recordBtn-mobile" class="btn btn-secondary" type="button">
              <span class="btn-icon-circle">
                <span id="micDot-mobile">ğŸ™</span>
              </span>
              <span class="btn-label" id="recordLabel-mobile">éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹</span>
            </button>

            <button id="sendBtn-mobile" class="btn btn-primary" type="button">
              <span class="spinner"></span>
              <span class="btn-label">AIè§£æã—ã¦ä¿å­˜</span>
            </button>
          </div>
        </section>
      </main>
    </div>

    <div id="toast-mobile" class="toast-mobile"></div>
  </div>

  <!-- PCç‰ˆãƒ­ã‚¸ãƒƒã‚¯ -->
  <script>
    (() => {
      const recordBtn = document.getElementById("recordBtn");
      const recordBtnLabel = document.getElementById("recordBtnLabel");
      const sendBtn = document.getElementById("sendBtn");
      const textOutput = document.getElementById("textOutput");
      const charCount = document.getElementById("charCount");
      const geoStatus = document.getElementById("geoStatus");

      let recognition;
      let isRecording = false;
      let isSending = false;

      if ("webkitSpeechRecognition" in window) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = "ja-JP";
        recognition.interimResults = true;
        recognition.continuous = true;

        recognition.onresult = (event) => {
          let finalText = "";
          for (let i = 0; i < event.results.length; i++) {
            finalText += event.results[i][0].transcript;
          }
          textOutput.value = finalText;
          updateCharCount();
        };

        recognition.onerror = (e) => {
          console.error("Speech error:", e);
          showToast("éŸ³å£°èªè­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
        };

        recognition.onend = () => {
          isRecording = false;
          updateRecordButton();
        };
      } else {
        showToast("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚", "error");
        recordBtn.disabled = true;
      }

      recordBtn.addEventListener("click", () => {
        if (!recognition || isSending) return;

        if (!isRecording) {
          recognition.start();
          isRecording = true;
        } else {
          recognition.stop();
          isRecording = false;
        }
        updateRecordButton();
      });

      function updateRecordButton() {
        if (!isRecording) {
          recordBtn.classList.remove("btn-danger");
          recordBtn.classList.add("btn-outline");
          recordBtnLabel.textContent = "éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹";
        } else {
          recordBtn.classList.remove("btn-outline");
          recordBtn.classList.add("btn-danger");
          recordBtnLabel.textContent = "éŸ³å£°å…¥åŠ›ã‚’åœæ­¢";
        }
      }

      function updateCharCount() {
        const len = textOutput.value.length;
        charCount.textContent = `${len} æ–‡å­—`;
      }

      textOutput.addEventListener("input", updateCharCount);

      let currentLat = null;
      let currentLng = null;

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            currentLat = pos.coords.latitude;
            currentLng = pos.coords.longitude;
            geoStatus.style.display = "inline-flex";
          },
          (err) => {
            console.warn("Geolocation error:", err);
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      }

      const toastEl = document.getElementById("toast-pc");
      const toastIconEl = document.getElementById("toastIcon-pc");
      const toastMsgEl = document.getElementById("toastMessage-pc");
      let toastTimer = null;

      function showToast(message, type = "info") {
        toastMsgEl.textContent = message;

        toastEl.classList.remove("success", "error");
        if (type === "success") {
          toastEl.classList.add("success");
          toastIconEl.textContent = "âœ…";
        } else if (type === "error") {
          toastEl.classList.add("error");
          toastIconEl.textContent = "âš ï¸";
        } else {
          toastIconEl.textContent = "â„¹ï¸";
        }

        toastEl.classList.add("show");

        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toastEl.classList.remove("show");
        }, 2600);
      }

      async function saveData() {
        if (isSending) return;

        const area = document.getElementById("area").value;
        const source = document.getElementById("source").value;
        const text = textOutput.value.trim();
        const age = document.getElementById("age").value;
        const gender = document.getElementById("gender").value;
        const occupation = document.getElementById("occupation").value;


        if (!text) {
          showToast("å†…å®¹ãŒç©ºã§ã™ã€‚å…¥åŠ›ã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„ã€‚", "error");
          return;
        }

        const payload = {
          text,
          area,
          source,
          age,
          gender,
          occupation,
          lat: currentLat,
          lng: currentLng,
        };

        try {
          isSending = true;
          sendBtn.disabled = true;
          recordBtn.disabled = true;
          sendBtn.classList.add("btn-loading");

          const res = await fetch("/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            console.error("API Error:", res.status, await res.text());
            showToast("AIè§£æã¾ãŸã¯ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "error");
            return;
          }

          const result = await res.json();
          console.log("è§£æçµæœ:", result);
          showToast("AIè§£æ â†’ Supabase ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸã€‚", "success");

          textOutput.value = "";
          updateCharCount();
        } catch (e) {
          console.error(e);
          showToast(
            "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
            "error"
          );
        } finally {
          isSending = false;
          sendBtn.disabled = false;
          recordBtn.disabled = !recognition;
          sendBtn.classList.remove("btn-loading");
          updateRecordButton();
        }
      }

      window.saveData = saveData;
    })();
  </script>

  <!-- ãƒ¢ãƒã‚¤ãƒ«ç‰ˆãƒ­ã‚¸ãƒƒã‚¯ -->
  <script>
    (() => {
      const textOutput = document.getElementById("textOutput-mobile");
      const charCountEl = document.getElementById("charCount-mobile");
      const recordBtn = document.getElementById("recordBtn-mobile");
      const recordLabel = document.getElementById("recordLabel-mobile");
      const micStatus = document.getElementById("micStatus-mobile");
      const micDot = document.getElementById("micDot-mobile");
      const sendBtn = document.getElementById("sendBtn-mobile");
      const geoStatus = document.getElementById("geoStatus-mobile");
      const toastEl = document.getElementById("toast-mobile");

      let currentLat = null;
      let currentLng = null;
      let isRecording = false;
      let isSending = false;
      let recognition = null;

      textOutput.addEventListener("input", () => {
        charCountEl.textContent = textOutput.value.length;
      });

      function initGeolocation() {
        if (!("geolocation" in navigator)) {
          geoStatus.textContent = "ğŸ“ ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“";
          geoStatus.classList.add("chip-error");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            currentLat = pos.coords.latitude;
            currentLng = pos.coords.longitude;
            geoStatus.textContent = "ğŸ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ";
            geoStatus.classList.remove("chip-error");
            geoStatus.classList.add("chip-success");
          },
          () => {
            geoStatus.textContent = "ğŸ“ ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ";
            geoStatus.classList.add("chip-error");
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      }

      function initSpeech() {
        if ("webkitSpeechRecognition" in window) {
          recognition = new webkitSpeechRecognition();
          recognition.lang = "ja-JP";
          recognition.interimResults = true;
          recognition.continuous = true;

          recognition.onresult = (event) => {
            let finalText = "";
            for (let i = 0; i < event.results.length; i++) {
              finalText += event.results[i][0].transcript;
            }
            textOutput.value = finalText;
            charCountEl.textContent = finalText.length;
          };

          recognition.onstart = () => {
            micStatus.textContent = "ğŸ™ éŒ²éŸ³ä¸­â€¦";
            micStatus.classList.remove("chip-error");
            micStatus.classList.add("chip-success");
          };

          recognition.onend = () => {
            micStatus.textContent = "ğŸ™ ãƒã‚¤ã‚¯å¾…æ©Ÿä¸­";
            micStatus.classList.remove("chip-success");
          };

          recognition.onerror = () => {
            micStatus.textContent = "ğŸ™ ãƒã‚¤ã‚¯ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
            micStatus.classList.add("chip-error");
          };
        } else {
          micStatus.textContent = "ğŸ™ ã“ã®ç«¯æœ«ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“";
          micStatus.classList.add("chip-error");
        }
      }

      function addPressAnimation(btn) {
        const start = () => btn.classList.add("btn-pressed");
        const end = () => btn.classList.remove("btn-pressed");
        btn.addEventListener("mousedown", start);
        btn.addEventListener("touchstart", start, { passive: true });
        window.addEventListener("mouseup", end);
        window.addEventListener("touchend", end);
        window.addEventListener("touchcancel", end);
      }

      addPressAnimation(recordBtn);
      addPressAnimation(sendBtn);

      recordBtn.addEventListener("click", () => {
        if (!recognition) {
          showToast("éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ãªã„ç«¯æœ«ã§ã™", true);
          return;
        }

        if (!isRecording) {
          recognition.start();
          isRecording = true;
          recordBtn.classList.add("recording");
          recordLabel.textContent = "éŸ³å£°å…¥åŠ›ã‚’åœæ­¢";
          micDot.innerHTML = '<span class="pulse-dot"></span>';
        } else {
          recognition.stop();
          isRecording = false;
          recordBtn.classList.remove("recording");
          recordLabel.textContent = "éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹";
          micDot.textContent = "ğŸ™";
        }
      });

      sendBtn.addEventListener("click", async () => {
        if (isSending) return;

        const areaEl = document.getElementById("area-mobile");
        const sourceEl = document.getElementById("source-mobile");

        // DOMãŒå£Šã‚Œã¦ã‚‹ / èª­ã¿è¾¼ã¿ãŒä¸å®Œå…¨ãªæ™‚ã«è½ã¡ãªã„ã‚ˆã†ã«ã‚¬ãƒ¼ãƒ‰
        if (!textOutput || !charCountEl || !sendBtn || !areaEl || !sourceEl) {
          alert("ç”»é¢ã®èª­ã¿è¾¼ã¿ãŒä¸å®Œå…¨ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        const area = areaEl.value || null;
        const source = sourceEl.value || null;
        const text = (textOutput.value || "").trim();

        if (!text) {
          showToast("å†…å®¹ãŒç©ºã§ã™", true);
          return;
        }

        isSending = true;
        sendBtn.classList.add("loading");
        sendBtn.disabled = true;

        const payload = {
          text,
          area,
          source,
          lat: currentLat,
          lng: currentLng,
        };

        const apiUrl = new URL("/analyze", window.location.origin).toString();

        try {
          const res = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const bodyText = await res.text();

          if (!res.ok) {
            console.error("API Error", res.status, bodyText);
            // ã‚¹ãƒãƒ›ã§ã‚‚åŸå› ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤º
            showToast(`é€ä¿¡å¤±æ•— (${res.status})ï¼š${bodyText.slice(0, 120)}`, true);
            return;
          }

          // æˆåŠŸæ™‚ï¼šJSONã®å¯èƒ½æ€§ãŒé«˜ã„ãŒã€å¿µã®ãŸã‚try
          try { JSON.parse(bodyText); } catch (_) {}

          showToast("é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸ âœ…");
          textOutput.value = "";
          charCountEl.textContent = "0";
        } catch (err) {
          console.error(err);
          showToast(`é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š${String(err).slice(0, 120)}`, true);
        } finally {
          isSending = false;
          sendBtn.classList.remove("loading");
          sendBtn.disabled = false;
        }
      });

      let toastTimeout = null;
      function showToast(message, isError = false) {
        toastEl.textContent = message;
        toastEl.classList.toggle("error", isError);
        toastEl.classList.add("show");
        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
          toastEl.classList.remove("show");
        }, 2300);
      }

      initGeolocation();
      initSpeech();
    })();
    </script>
  </body>
</html>
