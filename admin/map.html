<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kumano Compass - èª²é¡Œãƒãƒƒãƒ—</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --kc-bg: #f5f7fb;
      --kc-primary: #246bfd;
      --kc-primary-soft: rgba(36, 107, 253, 0.12);
      --kc-border: #dde3f0;
      --kc-text-main: #1f2933;
      --kc-text-sub: #6b7280;
      --kc-danger: #e53935;
      --kc-radius-lg: 16px;
      --kc-radius-md: 10px;
      --kc-shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.18);

      /* ãƒŠãƒ“é«˜ã•ï¼ˆ#mapã®æŠ¼ã—ä¸‹ã’ã«ä½¿ç”¨ï¼‰ */
      --kc-nav-height: 64px;
      --kc-nav-height-mobile: 70px;
    }

    * { box-sizing: border-box; }

    html { -webkit-text-size-adjust: 100%; }

    body {
      margin: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--kc-bg);
      color: var(--kc-text-main);
      overflow: hidden;
    }

    /* ãƒœã‚¿ãƒ³ã®ãƒ–ãƒ©ã‚¦ã‚¶æ—¢å®šã‚¹ã‚¿ã‚¤ãƒ«å·®ã‚’å¸å */
    button {
      font: inherit;
      color: inherit;
      -webkit-appearance: none;
      appearance: none;
    }

    /* =========================
       Kumano Compass å…±é€šãƒŠãƒ“ãƒãƒ¼
       ========================= */
    .kc-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--kc-nav-height);
      z-index: 1000;
      padding: 0 18px;

      display: flex;
      align-items: center;
      justify-content: center;

      background: radial-gradient(circle at top left,
                  rgba(226, 239, 255, 0.95),
                  rgba(255, 255, 255, 0.98));
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.10);
      border-bottom: 1px solid rgba(209, 213, 219, 0.7);
    }

    .kc-nav-inner {
      width: 100%;
      max-width: 1120px;
      margin: 0 auto;

      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      min-width: 0;
    }

    .kc-nav-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
      cursor: pointer;

      padding: 0;
      border: none;
      background: transparent;
      line-height: 1;
    }

    .kc-nav-logo-dot {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #ffffff 0, #93c5fd 35%, #2563eb 100%);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.22);
      animation: kc-nav-breath 3.2s ease-in-out infinite;
      flex: 0 0 auto;
    }

    .kc-nav-logo-text {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
      min-width: 0;
      line-height: 1.15;
    }

    .kc-nav-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.06em;
      color: #111827;
      margin: 0;
      line-height: 1.15;
      white-space: nowrap;
    }

    .kc-nav-sub {
      font-size: 11px;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
      margin: 0;
    }

    .kc-nav-center {
      flex: 1;
      display: flex;
      justify-content: center;
      gap: 8px;
      min-width: 0;
    }

    .kc-nav-link {
      position: relative;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 1;
      color: #4b5563;
      text-decoration: none;

      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;

      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;

      transition: background 0.18s ease-out, color 0.18s ease-out, transform 0.18s ease-out, border-color 0.18s ease-out;
      white-space: nowrap;
    }

    .kc-nav-link::after {
      content: "";
      position: absolute;
      left: 14px;
      right: 14px;
      bottom: 4px;
      height: 2px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.9);
      transform: scaleX(0);
      transform-origin: center;
      transition: transform 0.2s ease-out;
    }

    .kc-nav-link:hover {
      background: rgba(239, 246, 255, 0.95);
      border-color: rgba(59, 130, 246, 0.9);
      transform: translateY(-1px);
    }
    .kc-nav-link:hover::after { transform: scaleX(1); }

    .kc-nav-link.active {
      background: rgba(219, 234, 254, 0.95);
      color: #1d4ed8;
      border-color: rgba(37, 99, 235, 1);
    }
    .kc-nav-link.active::after { transform: scaleX(1); }

    .kc-nav-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 0 0 auto;
    }

    .kc-nav-cta {
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1;

      display: inline-flex;
      align-items: center;
      gap: 6px;

      cursor: pointer;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #ffffff;
      border: 1px solid rgba(37, 99, 235, 1);
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.45);

      transition: transform 0.16s ease-out, box-shadow 0.18s ease-out, opacity 0.16s ease-out, border-color 0.18s ease-out;
    }
    .kc-nav-cta:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(37, 99, 235, 0.55);
      border-color: #1d4ed8;
    }
    .kc-nav-cta:active {
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(37, 99, 235, 0.45);
    }

    /* =========================
       ãƒãƒƒãƒ—æœ¬ä½“
       ========================= */
    #map {
      position: absolute;
      inset: var(--kc-nav-height) 0 0 0;
      width: 100%;
      height: calc(100dvh - var(--kc-nav-height));
      z-index: 1;
    }

    /* =========================
       å‡¡ä¾‹ï¼ˆã‚«ãƒ†ã‚´ãƒªï¼‰
       ========================= */
    .legend {
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 12px;
      line-height: 1.35;
      font-size: 11px;
      border-radius: 14px;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.2);
      border: 1px solid rgba(209, 213, 219, 0.9);
    }
    .legend-title {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 11px;
      color: var(--kc-text-sub);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .legend-item:last-child { margin-bottom: 0; }

    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 3px; /* â† â€œä¸¸â€ã‚’ã‚„ã‚ã¦å››è§’å¯„ã‚Šã« */
      border: 1px solid rgba(17, 24, 39, 0.55);
      flex: 0 0 auto;
    }

    .legend-label {
      white-space: nowrap;
      line-height: 1.1;
    }

    /* =========================
       Leafletã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆæŠ¼ã—ã‚„ã™ã•ï¼‰
       ========================= */
    .leaflet-control-zoom {
      border-radius: 999px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.35);
    }
    .leaflet-control-zoom a {
      width: 32px;
      height: 32px;
      line-height: 30px;
      font-size: 18px;
    }

    /* =========================
       AIãƒ¬ãƒãƒ¼ãƒˆï¼šã‚µãƒãƒªãƒ¼ãƒ‘ãƒãƒ«
       ========================= */
    .summary-panel-wrapper {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 1100;
      padding: 0 6px calc(6px + env(safe-area-inset-bottom));
    }

    .summary-panel {
      margin: 0 auto;
      max-width: 960px;
      width: min(960px, calc(100% - 14px));
      background: #ffffff;
      border-radius: 16px 16px 0 0;
      box-shadow: var(--kc-shadow-soft);
      border-top: 1px solid rgba(226, 232, 240, 0.9);

      display: flex;
      flex-direction: column;

      transform: translateY(100%);
      opacity: 0;
      transition: transform 0.26s cubic-bezier(0.16, 0.84, 0.44, 1), opacity 0.2s ease-out;
      pointer-events: auto;

      /* ç”»é¢ä¸Šéƒ¨ï¼ˆãƒŠãƒ“ï¼‰ã‚’é¿ã‘ã‚‹ */
      max-height: min(74dvh, calc(100dvh - var(--kc-nav-height) - 12px));
    }

    .summary-panel.visible {
      transform: translateY(0%);
      opacity: 1;
    }

    .summary-handle {
      width: 40px;
      height: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
      margin: 8px auto 4px;
      flex: 0 0 auto;
    }

    .summary-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px 8px;
      border-bottom: 1px solid #edf2ff;
      flex: 0 0 auto;
    }

    .summary-header-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .summary-title {
      font-size: clamp(13px, 1.2vw, 15px);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }

    .summary-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--kc-primary-soft);
      color: var(--kc-primary);
      flex: 0 0 auto;
    }

    .summary-subtitle {
      font-size: clamp(11px, 1vw, 13px);
      color: var(--kc-text-sub);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .summary-close-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--kc-text-sub);
      transition: background 0.12s ease-out, transform 0.12s ease-out;
      flex: 0 0 auto;
    }
    .summary-close-btn:hover {
      background: #f3f4ff;
      transform: rotate(5deg);
    }

    .summary-body {
      padding: 12px 16px 18px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;

      font-size: clamp(13px, 1.15vw, 15px);
      line-height: 1.75;
      color: #374151;

      overflow-wrap: anywhere;
      word-break: break-word;

      flex: 1 1 auto;
      min-height: 0;
    }

    .summary-body::-webkit-scrollbar { width: 6px; }
    .summary-body::-webkit-scrollbar-thumb {
      background: #cbd5f5;
      border-radius: 999px;
    }

    .summary-loading {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--kc-text-sub);
    }
    .spinner {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid #cbd5ff;
      border-top-color: var(--kc-primary);
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(1turn); } }

    /* ===== Leaflet popupå†…ã®AIãƒœã‚¿ãƒ³ ===== */
    .popup-ai-btn {
      margin-top: 6px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      background: var(--kc-primary-soft);
      color: var(--kc-primary);
      font-size: 11px;
      cursor: pointer;
      transition: background 0.12s ease-out, transform 0.12s ease-out, box-shadow 0.12s ease-out;
    }
    .popup-ai-btn:hover {
      background: rgba(36, 107, 253, 0.18);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.25);
    }
    .popup-ai-btn:active { transform: translateY(0); box-shadow: none; }

    /* =========================
       â€œç¸®å°è¡¨ç¤º(PEEK)â€ã®ãŸã‚ã®ã‚¯ãƒ©ã‚¹ï¼ˆJSã§ä»˜ä¸ã•ã‚Œã‚‹ï¼‰
       ========================= */
    .summary-preview { display: none; padding: 10px 16px 14px; border-top: 1px solid rgba(226, 232, 240, 0.9); color: #475569; font-size: 13px; line-height: 1.45; }
    .summary-preview-hint { margin-top: 6px; font-size: 12px; color: #64748b; }
    .summary-panel.peek .summary-body { display: none; }
    .summary-panel.peek .summary-preview { display: block; }

    /* ç¸®å°çŠ¶æ…‹ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã ã‘æ®‹ã—ã¦ä¸‹ã«é€€é¿ï¼ˆåœ°å›³ã‚’åºƒãï¼‰ */
    .summary-panel.visible.peek {
      transform: translateY(calc(100% - 104px - env(safe-area-inset-bottom)));
      opacity: 1;
    }

    /* ãƒ¬ãƒãƒ¼ãƒˆæ•´å½¢ï¼ˆè¦‹å‡ºã—/ç®‡æ¡æ›¸ãï¼‰ */
    .report h3 { font-size: 15px; margin: 12px 0 6px; padding-top: 4px; }
    .report p { margin: 6px 0; }
    .report ul { margin: 6px 0 10px; padding-left: 18px; }
    .report li { margin: 4px 0; }
    .report .report-error {
      color: #b91c1c;
      background: rgba(254, 226, 226, 0.7);
      border: 1px solid rgba(252, 165, 165, 0.9);
      padding: 10px 12px;
      border-radius: 10px;
      line-height: 1.55;
    }

    /* =========================
       ã‚¹ãƒãƒ›æœ€é©åŒ–
       ========================= */
    @media (max-width: 768px) {
      /* #mapãƒ»ãƒ‘ãƒãƒ«ã®æŠ¼ã—ä¸‹ã’é‡ã‚’ã‚¹ãƒãƒ›ç”¨ã« */
      #map {
        inset: var(--kc-nav-height-mobile) 0 0 0;
        height: calc(100dvh - var(--kc-nav-height-mobile));
      }

      .kc-nav {
        height: var(--kc-nav-height-mobile);
        padding: 6px 10px;
      }

      .kc-nav-left { gap: 6px; }

      .kc-nav-logo-dot { width: 22px; height: 22px; }

      .kc-nav-title { font-size: 13px; }

      /* èª¬æ˜æ–‡ã¯ã‚¹ãƒãƒ›ã§ã¯éè¡¨ç¤ºã«ã—ã¦ãƒŠãƒ“ã‚’ã‚¹ãƒƒã‚­ãƒª */
      .kc-nav-sub { display: none; }

      /* ä¸­å¤®ã‚¿ãƒ–ï¼šæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ç¸¦æŠ˜ã‚Œé˜²æ­¢ */
      .kc-nav-center {
        justify-content: flex-start;
        gap: 6px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      .kc-nav-center::-webkit-scrollbar { display: none; }

      .kc-nav-link {
        flex: 0 0 auto;
        min-width: 82px;
        padding: 10px 10px;
        font-size: 11px;
      }

      .kc-nav-cta {
        padding: 6px 10px;
        font-size: 11px;
      }

      /* å‡¡ä¾‹ï¼šèª­ã¿ã‚„ã™ã•ã ã‘ç¶­æŒï¼ˆâ€œä¸¸â€åŒ–ã—ãªã„ï¼‰ */
      .legend {
        font-size: 10px;
        padding: 8px 10px;
        border-radius: 14px;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.25);
      }
      .legend-title { font-size: 10px; }

      /* ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆï¼ˆAIãƒ¬ãƒãƒ¼ãƒˆï¼‰ã¯ãƒ•ãƒ«å¹…ã«è¿‘ã */
      .summary-panel {
        width: calc(100% - 10px);
        border-radius: 18px 18px 0 0;
        max-height: min(80dvh, calc(100dvh - var(--kc-nav-height-mobile) - 12px));
      }

      .summary-header { padding: 12px 14px 8px; }
      .summary-title { font-size: 15px; }
      .summary-subtitle { font-size: 12px; }

      .summary-body {
        font-size: 15px;
        line-height: 1.85;
        padding: 12px 14px calc(18px + env(safe-area-inset-bottom));
      }
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes kc-nav-breath {
      0% { transform: scale(1); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.22); }
      50% { transform: scale(1.06); box-shadow: 0 0 0 8px rgba(37, 99, 235, 0.0); }
      100% { transform: scale(1); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.22); }
    }
  </style>
</head>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const links = document.querySelectorAll(".kc-nav-link");
    if (!links.length) return;

    // ç¾åœ¨ã®ãƒ‘ã‚¹ã‚’å–å¾—ã—ã¦æœ«å°¾ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å‰Šã‚‹ï¼ˆ/admin/ â†’ /adminï¼‰
    const rawPath = window.location.pathname || "/";
    const currentPath =
      rawPath.length > 1 ? rawPath.replace(/\/+$/, "") : rawPath;

    links.forEach((btn) => {
      const href = btn.getAttribute("data-nav-href");
      if (!href) return;

      const hrefNorm =
        href.length > 1 ? href.replace(/\/+$/, "") : href;

      // å®Œå…¨ä¸€è‡´ã—ãŸã¨ãã ã‘ active ã‚’ä»˜ä¸
      if (currentPath === hrefNorm) {
        btn.classList.add("active");
      }

      btn.addEventListener("click", () => {
        window.location.href = href;
      });
    });

    // ï¼ˆãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å¾Œã§å…¥ã‚ŒãŸã„å ´åˆç”¨ã®ãƒ•ãƒƒã‚¯ï¼‰
    const burger = document.querySelector(".kc-nav-burger");
    const mobileMenu = document.querySelector(".kc-nav-mobile-menu");
    if (burger && mobileMenu) {
      burger.addEventListener("click", () => {
        burger.classList.toggle("open");
        mobileMenu.classList.toggle("open");
      });

      mobileMenu.querySelectorAll("[data-nav-href]").forEach((item) => {
        item.addEventListener("click", () => {
          const href = item.getAttribute("data-nav-href");
          if (href) {
            window.location.href = href;
          }
        });
      });
    }
  });
</script>
<body>
  <div class="kc-nav">
  <div class="kc-nav-inner">
    <!-- å·¦ãƒ­ã‚´ï¼šã‚¯ãƒªãƒƒã‚¯ã§ä¸€è¦§ã¸æˆ»ã‚‹ -->
    <button
      class="kc-nav-left"
      type="button"
      onclick="window.location.href='/admin'"
    >
      <div class="kc-nav-logo-dot"></div>
      <div class="kc-nav-logo-text">
        <div class="kc-nav-title">Kumano Compass</div>
        <div class="kc-nav-sub">èª²é¡Œãƒãƒƒãƒ— Â· åœ°åŸŸã®å£° Ã— AI</div>
      </div>
    </button>

    <div class="kc-nav-center">
      <button
        class="kc-nav-link"
        type="button"
        data-nav-href="/public/index.html"
        data-nav-key="input"
      >
        <span>ğŸ“</span><span>å…¥åŠ›</span>
      </button>
      <button
        class="kc-nav-link"
        type="button"
        data-nav-href="/admin"
        data-nav-key="admin"
      >
        <span>ğŸ“Š</span><span>ä¸€è¦§</span>
      </button>
      <button
        class="kc-nav-link"
        type="button"
        data-nav-href="/admin/map"
        data-nav-key="map"
      >
        <span>ğŸ—º</span><span>ãƒãƒƒãƒ—</span>
      </button>
    </div>

    <!-- å³å´ï¼šå…¨ä½“AIãƒ¬ãƒãƒ¼ãƒˆCTA -->
    <div class="kc-nav-right">
      <button
        class="kc-nav-cta"
        type="button"
        onclick="fetchGlobalReport()"
        title="å…¨ä½“AIãƒ¬ãƒãƒ¼ãƒˆ"
      >
        <span>ğŸ’¡</span><span>å…¨ä½“AIãƒ¬ãƒãƒ¼ãƒˆ</span>
      </button>
    </div>
  </div>
</div>

  <!-- ãƒãƒƒãƒ— -->
  <div id="map"></div>

  <!-- AIãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºãƒ‘ãƒãƒ« -->
  <div class="summary-panel-wrapper">
    <div id="summary-panel" class="summary-panel">
      <div class="summary-handle"></div>
      <div class="summary-header">
        <div class="summary-header-main">
          <div class="summary-title">
            <span id="summary-icon">ğŸ’¡</span>
            <span id="summary-title-text">AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ</span>
            <span id="summary-chip" class="summary-chip">
              <span>å…¨ä½“</span>
            </span>
          </div>
          <div id="summary-subtitle" class="summary-subtitle">
            åœ°åŸŸå…¨ä½“ã®å‚¾å‘ã‚„èƒŒæ™¯ã€ä»Šå¾Œã®è«–ç‚¹ã‚’AIãŒæ•´ç†ã—ã¾ã™ã€‚
          </div>
        </div>
        <button
          class="summary-close-btn"
          onclick="hideSummaryPanel()"
          title="é–‰ã˜ã‚‹"
        >
          âœ•
        </button>
      </div>
      <div id="summary-body" class="summary-body">
        ã“ã“ã«AIã«ã‚ˆã‚‹åˆ†æãƒ¬ãƒãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    //  Leaflet ãƒãƒƒãƒ—ã®åˆæœŸåŒ–
    // ----------------------------
    const map = L.map("map").setView([33.88, 136.1], 9);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    // ä½æ°‘ã®å£°ãƒãƒ¼ã‚«ãƒ¼ï¼ˆå†èª­ã¿è¾¼ã¿æ™‚ã«ã‚¯ãƒªã‚¢ã§ãã‚‹ã‚ˆã†ã«ï¼‰
    const voiceLayer = L.layerGroup().addTo(map);

    function lockMapScrollWhenReportOpen() {
      const panel = document.querySelector(".summary-panel");
      if (!panel || !window.L || !L.DomEvent) return;

      L.DomEvent.disableScrollPropagation(panel);
      L.DomEvent.disableClickPropagation(panel);

      const body = panel.querySelector(".summary-body");
      if (body) {
        L.DomEvent.disableScrollPropagation(body);
        L.DomEvent.disableClickPropagation(body);
      }
    }
    lockMapScrollWhenReportOpen();

    // ----------------------------
    //  åœ°åŒº â†’ ä»£è¡¨åº§æ¨™
    // ----------------------------
    const AREA_COORDS = {
      ç¥å·: [33.957, 136.004],
      æœ¨æœ¬: [33.887, 136.101],
      é£›é³¥: [33.936, 136.2],
      å¸‚æœ¨: [33.957, 136.3],
      ç´€å’Œ: [33.899, 135.96],
    };

    // ----------------------------
    //  ã‚«ãƒ†ã‚´ãƒª â†’ è‰²
    // ----------------------------
    const CATEGORY_COLORS = {
      äº¤é€š: "#e53935",
      åŒ»ç™‚: "#8e24aa",
      "é«˜é½¢åŒ–ãƒ»ç¦ç¥‰": "#3949ab",
      "å­è‚²ã¦ãƒ»æ•™è‚²": "#1e88e5",
      è¦³å…‰: "#00897b",
      "å•†åº—è¡—ãƒ»åœ°åŸŸçµŒæ¸ˆ": "#43a047",
      è‡ªç„¶ç’°å¢ƒ: "#fdd835",
      "é˜²ç½ãƒ»æ´¥æ³¢": "#fb8c00",
      è¡Œæ”¿ã‚µãƒ¼ãƒ“ã‚¹: "#6d4c41",
      æœªåˆ†é¡: "#757575",
    };

    function getCategoryColor(category) {
      return CATEGORY_COLORS[category] || "#3388ff";
    }

    // é‡è¦åº¦ã‚¹ã‚³ã‚¢ â†’ ãƒãƒ¼ã‚«ãƒ¼åŠå¾„
    function getMarkerRadius(importance) {
      const base = 6;
      if (typeof importance !== "number" || isNaN(importance)) {
        return base;
      }
      const extra = Math.min(8, importance * 2);
      return base + extra;
    }

    // åŒã˜åœ°åŒºã®ãƒãƒ¼ã‚«ãƒ¼é‡ãªã‚Šé˜²æ­¢ï¼ˆå°‘ã—ã ã‘åº§æ¨™ã‚’ãšã‚‰ã™ï¼‰
    function jitterCoords(lat, lng, uniqueKey) {
      let hash = 0;
      for (let i = 0; i < uniqueKey.length; i++) {
        hash = (hash * 31 + uniqueKey.charCodeAt(i)) & 0xffffffff;
      }
      const angle = ((hash % 360) * Math.PI) / 180;
      const maxDistance = 0.0005;
      const distance = (((hash >>> 8) % 100) / 100) * maxDistance;
      const dLat = Math.cos(angle) * distance;
      const dLng = Math.sin(angle) * distance;

      return { lat: lat + dLat, lng: lng + dLng };
    }

    // ----------------------------
    //  Supabaseç”±æ¥ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆFastAPI çµŒç”±ï¼‰
    // ----------------------------
    async function loadVoices() {
      try {
        const res = await fetch("/admin/api/voices?limit=2000");
        if (!res.ok) {
          console.error("API error", res.status, await res.text());
          return;
        }
        const voices = await res.json();
        plotVoices(voices);
      } catch (e) {
        console.error("loadVoices error:", e);
      }
    }

    // ----------------------------
    //  ãƒãƒ¼ã‚«ãƒ¼æç”»
    // ----------------------------
    function plotVoices(voices) {
      voiceLayer.clearLayers();

      voices.forEach((v) => {
        let lat = v.lat;
        let lng = v.lng;
        let usedAreaFallback = false;

        // ä½ç½®æƒ…å ±ãŒç„¡ã„å ´åˆã¯åœ°åŒºä»£è¡¨åº§æ¨™
        if ((lat == null || lng == null) && v.area && AREA_COORDS[v.area]) {
          [lat, lng] = AREA_COORDS[v.area];
          usedAreaFallback = true;
        }

        if (lat == null || lng == null) return;

        // åœ°åŒºä»£è¡¨åº§æ¨™çµŒç”±ã®ã¨ãã®ã¿ã€idãƒ™ãƒ¼ã‚¹ã§å°‘ã—ãšã‚‰ã™
        if (usedAreaFallback && v.id) {
          const jittered = jitterCoords(lat, lng, v.id);
          lat = jittered.lat;
          lng = jittered.lng;
        }

        const color = getCategoryColor(v.category);
        const radius = getMarkerRadius(v.importance_score);

        const marker = L.circleMarker([lat, lng], {
          radius,
          color,
          fillColor: color,
          fillOpacity: 0.8,
          weight: 2,
        }).addTo(voiceLayer);

        const sentimentText = v.sentiment
          ? `${v.sentiment} (${(v.sentiment_score ?? 0).toFixed(2)})`
          : "-";

        const importanceText =
          typeof v.importance_score === "number"
            ? v.importance_score.toFixed(2)
            : "-";

        const sourceLabel =
          v.source === "local"
            ? "åœ°åŸŸã®æ–¹ã€…"
            : v.source === "ivusa"
            ? "å­¦ç”Ÿ"
            : v.source === "tourist"
            ? "è¦³å…‰å®¢"
            : (v.source ?? "-");

        const attrParts = [];
        if (sourceLabel && sourceLabel !== "-") attrParts.push(sourceLabel);
        if (v.age) attrParts.push(v.age);
        if (v.gender) attrParts.push(v.gender);
        if (v.occupation) attrParts.push(v.occupation);
        const attrText = attrParts.length ? attrParts.join(" / ") : "-";

        const popupHtml = `
          <div style="font-size:12px;">
            <strong>åœ°åŒº:</strong> ${v.area ?? "-"}<br/>
            <strong>å±æ€§:</strong> ${attrText}<br/>
            <strong>ã‚«ãƒ†ã‚´ãƒª:</strong> ${v.category ?? "-"}<br/>
            <strong>æ„Ÿæƒ…:</strong> ${sentimentText}<br/>
            <strong>é‡è¦åº¦:</strong> ${importanceText}<br/>
            <hr/>
            <strong>å†…å®¹:</strong><br/>
            ${(v.raw_text ?? "").replace(/\n/g, "<br/>")}
            <div style="margin-top:6px;">
              <button class="popup-ai-btn" onclick="openVoiceReport('${
                v.id
              }', '${(v.area ?? "").replace(/'/g, "\\'")}')">
                <span>ğŸ”</span><span>ã“ã®åœ°ç‚¹ã‚’AIåˆ†æ</span>
              </button>
            </div>
          </div>
        `;

        marker.bindPopup(popupHtml);
      });

      addLegend();
    }

    // ----------------------------
    //  å‡¡ä¾‹
    // ----------------------------
    function addLegend() {
      const legend = L.control({ position: "bottomright" });

      legend.onAdd = function () {
        const div = L.DomUtil.create("div", "legend");
        div.innerHTML = `<div class="legend-title">CATEGORY</div>`;
        Object.entries(CATEGORY_COLORS).forEach(([cat, color]) => {
          const item = document.createElement("div");
          item.className = "legend-item";

          const dot = document.createElement("span");
          dot.className = "legend-color";
          dot.style.backgroundColor = color;

          const label = document.createElement("span");
          label.className = "legend-label";
          label.textContent = cat;

          item.appendChild(dot);
          item.appendChild(label);
          div.appendChild(item);
        });
        return div;
      };

      legend.addTo(map);
    }

  // ----------------------------
  //  AIãƒ¬ãƒãƒ¼ãƒˆç”¨ã‚µãƒãƒªãƒ¼ãƒ‘ãƒãƒ«åˆ¶å¾¡ï¼ˆMobileæœ€é©åŒ–ï¼‰
  // ----------------------------
  const summaryPanel = document.getElementById("summary-panel");
  const summaryBody = document.getElementById("summary-body");
  const summaryTitleText = document.getElementById("summary-title-text");
  const summaryIcon = document.getElementById("summary-icon");
  const summaryChip = document.getElementById("summary-chip");
  const summarySubtitle = document.getElementById("summary-subtitle");

  let summaryState = "hidden"; // "hidden" | "full" | "peek"

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é ˜åŸŸã‚’JSã§è¿½åŠ ï¼ˆHTMLã‚’ã„ã˜ã‚‰ãªãã¦OKï¼‰
  const previewEl = document.createElement("div");
  previewEl.id = "summary-preview";
  previewEl.className = "summary-preview";
  previewEl.innerHTML = `
    <div id="summary-preview-text"></div>
    <div class="summary-preview-hint">â†‘ ã‚¿ãƒƒãƒ—ã§æ‹¡å¤§ / âœ•ã§é–‰ã˜ã‚‹</div>
  `;
  summaryBody.parentNode.insertBefore(previewEl, summaryBody);
  const previewTextEl = document.getElementById("summary-preview-text");

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã€Œç¸®å°/æ‹¡å¤§ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
  const closeBtn = summaryPanel.querySelector(".summary-close-btn");
  const minBtn = document.createElement("button");
  minBtn.type = "button";
  minBtn.className = "summary-close-btn";
  minBtn.title = "ç¸®å°/æ‹¡å¤§";
  minBtn.style.marginRight = "8px";
  minBtn.textContent = "â–¾";
  closeBtn.parentNode.insertBefore(minBtn, closeBtn);

  function setSummaryState(next) {
    summaryState = next;

    summaryPanel.classList.toggle("visible", next !== "hidden");
    summaryPanel.classList.toggle("peek", next === "peek");
    summaryPanel.classList.toggle("full", next === "full");

    // ãƒœã‚¿ãƒ³è¡¨ç¤ºï¼ˆç¸®å°æ™‚ã¯â–´ã€æ‹¡å¤§æ™‚ã¯â–¾ï¼‰
    if (next === "peek") minBtn.textContent = "â–´";
    if (next === "full") minBtn.textContent = "â–¾";
  }

  function showSummaryPanel(mode = "full") {
    setSummaryState(mode);
  }

  function hideSummaryPanel() {
    setSummaryState("hidden");
  }

  // ã‚¿ãƒƒãƒ—ã§ç¸®å°/æ‹¡å¤§
  function toggleSummaryPanelSize() {
    if (summaryState === "full") setSummaryState("peek");
    else if (summaryState === "peek") setSummaryState("full");
    else setSummaryState("full");
  }

  minBtn.addEventListener("click", (e) => {
    e.preventDefault();
    toggleSummaryPanelSize();
  });

  // ãƒãƒ³ãƒ‰ãƒ«ã‚‚ã‚¿ãƒƒãƒ—ã§ç¸®å°/æ‹¡å¤§
  const handleEl = summaryPanel.querySelector(".summary-handle");
  if (handleEl) {
    handleEl.addEventListener("click", (e) => {
      e.preventDefault();
      toggleSummaryPanelSize();
    });
  }

  // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºã‚’ã€Œèª­ã¿ã‚„ã™ã„HTMLã€ã«æ•´å½¢
  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function formatReportTextToHtml(text) {
    const lines = String(text || "").split(/\r?\n/);
    let html = `<div class="report">`;
    let inList = false;

    for (const raw of lines) {
      const line = raw.trimEnd();
      if (!line.trim()) {
        if (inList) { html += `</ul>`; inList = false; }
        continue;
      }

      // è¦‹å‡ºã—ï¼š "1." "2)" "3ã€" ãªã©
      if (/^\d+\s*[\.\)\ã€]/.test(line)) {
        if (inList) { html += `</ul>`; inList = false; }
        html += `<h3>${escapeHtml(line)}</h3>`;
        continue;
      }

      // ç®‡æ¡æ›¸ãï¼š "- " "ãƒ»" "â€¢"
      if (/^(\-|\ãƒ»|\â€¢)\s*/.test(line)) {
        if (!inList) { html += `<ul>`; inList = true; }
        html += `<li>${escapeHtml(line.replace(/^(\-|\ãƒ»|\â€¢)\s*/, ""))}</li>`;
        continue;
      }

      // é€šå¸¸æ–‡
      if (inList) { html += `</ul>`; inList = false; }
      html += `<p>${escapeHtml(line)}</p>`;
    }

    if (inList) html += `</ul>`;
    html += `</div>`;
    return html;
  }

  function setReportText(text) {
    const t = text ?? "";
    summaryBody.innerHTML = formatReportTextToHtml(t);

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€åˆã®2ã€œ3è¡Œã‚’æŠ½å‡ºï¼‰
    const pick = String(t).split(/\r?\n/).map(s => s.trim()).filter(Boolean).slice(0, 3);
    previewTextEl.textContent = pick.join(" / ") || "ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚";

    // å…ˆé ­ã¸
    summaryBody.scrollTop = 0;
  }

  function setErrorText(message) {
    summaryBody.innerHTML = `<div class="report report-error">${escapeHtml(message)}</div>`;
    previewTextEl.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
    summaryBody.scrollTop = 0;
  }

  function showLoading(text = "AIãŒåˆ†æã—ã¦ã„ã¾ã™â€¦") {
    summaryBody.innerHTML = `
      <div class="summary-loading">
        <div class="spinner"></div>
        <span>${escapeHtml(text)}</span>
      </div>
    `;
    previewTextEl.textContent = "AIãŒåˆ†æä¸­ã§ã™â€¦";
  }

    // ----------------------------
    //  å…¨ä½“AIãƒ¬ãƒãƒ¼ãƒˆå–å¾—
    // ----------------------------
    async function fetchGlobalReport() {
      summaryTitleText.textContent = "å…¨ä½“AIãƒ¬ãƒãƒ¼ãƒˆ";
      summaryIcon.textContent = "ğŸ’¡";
      summaryChip.innerHTML = "<span>å…¨ä½“</span>";
      summarySubtitle.textContent =
        "å…¨ä½“ã®å‚¾å‘ãƒ»ã‚¨ãƒªã‚¢åˆ¥ã®ç‰¹å¾´ãƒ»å„ªå…ˆåº¦ã®é«˜ã„è«–ç‚¹ã‚’AIãŒæ•´ç†ã—ã¾ã™ã€‚";

      showSummaryPanel();
      showLoading();

      try {
        const res = await fetch("/admin/api/report/global");
        if (!res.ok) {
          const t = await res.text();
          summaryBody.textContent =
            "ãƒ¬ãƒãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + res.status + " / " + t;
          return;
        }
        const data = await res.json();
       setReportText(data.text ?? "ãƒ¬ãƒãƒ¼ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
      } catch (e) {
        console.error(e);
        summaryBody.textContent = "ãƒ¬ãƒãƒ¼ãƒˆå–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      }
    }

    // ----------------------------
    //  å€‹åˆ¥ã‚¹ãƒãƒƒãƒˆAIãƒ¬ãƒãƒ¼ãƒˆ
    //  ï¼ˆLeafletãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
    // ----------------------------
    async function openVoiceReport(voiceId, areaLabel) {
      summaryTitleText.textContent = "ã‚¹ãƒãƒƒãƒˆAIåˆ†æ";
      summaryIcon.textContent = "ğŸ”";
      summaryChip.innerHTML = `<span>${areaLabel || "å€‹åˆ¥"}</span>`;
      summarySubtitle.textContent =
        "ã“ã®åœ°ç‚¹ã«é–¢ã™ã‚‹èª²é¡Œã®èƒŒæ™¯ã‚„æ½œåœ¨çš„ãªè«–ç‚¹ã€é–¢ä¿‚è€…ã”ã¨ã®æ‰“ã¡æ‰‹ã‚’AIãŒæ•´ç†ã—ã¾ã™ã€‚";

      showSummaryPanel();
      showLoading("ã“ã®åœ°ç‚¹ã®æƒ…å ±ã‚’åˆ†æã—ã¦ã„ã¾ã™â€¦");

      try {
        const res = await fetch(`/admin/api/report/voice/${voiceId}`);
        if (!res.ok) {
          const t = await res.text();
          setErrorText("ãƒ¬ãƒãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + res.status + " / " + t);
          return;
        }
        const data = await res.json();
        setReportText(data.text ?? "ãƒ¬ãƒãƒ¼ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
      } catch (e) {
        console.error(e);
        setErrorText("ãƒ¬ãƒãƒ¼ãƒˆå–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    }

    // Leafletãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
    window.openVoiceReport = openVoiceReport;

    // å®Ÿè¡Œ
    loadVoices();
  </script>
</body>
</html>